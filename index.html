 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>استمارة تسجيل كابتن بلي</title>

<style>
body {background:#f2f2f2; font-family:Tahoma; margin:0; padding:0;}
.container {max-width:650px; background:#fff; margin:20px auto; padding:25px; border-radius:14px; box-shadow:0 4px 16px rgba(0,0,0,0.15);}
h2 {text-align:center; margin-bottom:20px;}
label {font-weight:bold; margin-top:12px; display:block;}
.inputBox {background:#fafafa; border:1px solid #ddd; padding:12px; border-radius:10px; margin-top:6px;}
input[type="text"], input[type="tel"], input[type="file"] {width:100%; border:none; background:none; outline:none; font-size:15px;}
.preview {margin-top:8px; display:none; width:100%; border-radius:8px;}
button {width:100%; margin-top:20px; padding:14px; background:#0077ff; color:#fff; border:none; border-radius:10px; font-size:18px; cursor:pointer;}
button:hover {background:#005fe0;}
.success {text-align:center; font-size:26px; color:green; padding:40px 0; line-height:1.8;}
</style>
</head>

<body>

<div class="container" id="formBox">

<h2>استمارة تسجيل كابتن بلي</h2>

<form id="uploadForm">

<label>الاسم الثلاثي</label>
<div class="inputBox"><input type="text" name="name" required></div>

<label>رقم الهاتف (واتساب)</label>
<div class="inputBox"><input type="tel" name="phone" required></div>

<label>الهوية – الوجه الأمامي</label>
<div class="inputBox">
    <input type="file" name="id_front" required>
</div>

<label>الهوية – الوجه الخلفي</label>
<div class="inputBox">
    <input type="file" name="id_back" required>
</div>

<label>فيديو الهوية الوجه والخلف</label>
<div class="inputBox">
    <input type="file" name="id_video" required>
</div>

<label>صورة شخصية</label>
<div class="inputBox">
    <input type="file" name="selfie" required>
</div>

<button type="submit">إرسال الطلب</button>

</form>

</div>

<script>

const API = "https://taxi-virid.vercel.app/api/upload";

async function uploadToBackblaze(file) {

  // 1) الحصول على رابط الرفع من Vercel API
  const meta = await fetch(API, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      fileName: Date.now() + "_" + file.name,
      fileType: file.type
    })
  });

  const info = await meta.json();
  if (!info.ok) throw new Error(info.error);

  // 2) رفع الملف إلى Backblaze B2
  const upload = await fetch(info.uploadUrl, {
    method: "POST",
    headers: {
      "Authorization": info.uploadToken,
      "X-Bz-File-Name": info.fileName,
      "Content-Type": file.type,
      "X-Bz-Content-Sha1": "do_not_verify"
    },
    body: file
  });

  if (!upload.ok) {
    const t = await upload.text();
    throw new Error("Upload error: " + t);
  }

  return info.downloadUrl;
}

document.getElementById("uploadForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const btn = e.target.querySelector("button");
  btn.disabled = true;
  btn.innerText = "جاري الرفع...";

  const formData = new FormData(e.target);
  const entries = [...formData.entries()];

  let uploaded = [];

  try {

    for (let [key, file] of entries) {
      if (typeof file === "object") {
        const url = await uploadToBackblaze(file);
        uploaded.push({ key, url });
      }
    }

    document.getElementById("formBox").innerHTML =
      `<div class="success">✔ تم رفع الملفات بنجاح<br>
       سيتم التواصل معك قريبًا</div>`;

    console.log(uploaded);

  } catch (err) {
    alert("خطأ أثناء الرفع: " + err.message);
    btn.disabled = false;
    btn.innerText = "إرسال الطلب";
  }

});

</script>

</body>
</html>
